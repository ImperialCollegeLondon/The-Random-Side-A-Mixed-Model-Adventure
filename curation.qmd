---
title: "Data Curation"
format: html
editor: visual
---

It is very important to have your data ready and in the right format before you run any models. This section of the tutorial will allow you practice cleaning the data set.

## About the dataset

The dataset contains simulated data for 2,000 adults from eight study sites (UK, USA, Colombia, India, South Africa, Poland, Vietnam, and Australia). It was generated to illustrate mixed-effects modeling and data cleaning workflows in respiratory epidemiology. Each participant has demographic, occupational, and lung function information designed to reflect a realistic example.

### üßπ Let‚Äôs Get Cleaning!

Before jumping into mixed-modelling, we need to tackle some messy data. The **dirty dataset (`mixed_dirty.txt`)** mirrors the kind of inconsistencies found in real epidemiological studies, including: typos, missing entries, odd units, and empty spaces.

| Variable | Description |
|----|----|
| **id** | Unique participant identifier (1‚Äì2000) |
| **site** | Study site (country: UK, USA, Colombia, India, South Africa, Poland, Vietnam, or Australia) |
| **age** | Participant age in years (contains missing values) |
| **sex** | Recorded sex (e.g., ‚ÄúM‚Äù, ‚ÄúF‚Äù, ‚Äúmale‚Äù, ‚ÄúFemale‚Äù, ‚Äúf‚Äù, ‚Äúm‚Äù, ‚Äúother‚Äù) |
| **height_cm** | Height in centimetres (may include blanks, ‚ÄúNA‚Äù, or blank spaces) |
| **weight_kg** | Weight in kilograms (some missing or inconsistent entries) |
| **BMI** | Body mass index derived from height and weight; includes rounding errors and missing values |
| **smoking_status** | Self-reported smoking behaviour with inconsistent text (e.g., ‚ÄúNever‚Äù, ‚Äúnever‚Äù, ‚ÄúCURRENT‚Äù, ‚Äúex‚Äù, ‚Äúquit\>1y‚Äù, ‚ÄúUnknown‚Äù) |
| **pack_years** | Approximate pack-years of smoking exposure (some missing or inconsistent with smoking status) |
| **education** | Educational attainment (free-text responses such as ‚Äúprimary‚Äù, ‚Äúsec‚Äù, ‚ÄúCollege‚Äù, ‚Äúuni‚Äù, or blanks) |
| **job** | Reported occupation, intentionally messy (e.g., ‚Äúnuse‚Äù, ‚Äúmining‚Äù, ‚Äúconstructor‚Äù, ‚Äúteacher‚Äù, ‚Äúoffice‚Äù) |
| **exposure_cat** | Occupational exposure category (‚Äúlow‚Äù or ‚Äúhigh_exposure‚Äù) with inconsistent naming |
| **FEV1_mL** | Forced Expiratory Volume in 1 second, in millilitres; includes outliers, missing values, and some negative entries |
| **FVC_mL** | Forced Vital Capacity, in millilitres; includes missing values |

> *Note:* The `mixed_dirty.txt` dataset includes deliberate inconsistencies and data quality issues for you to identify and correct during cleaning exercises (e.g., converting FEV1/FVC to litres, standardise categorical variables, and deriving exposure categories).

Your task is to explore, clean, and prepare it for analysis.

## Install relevant packages and load your data

For this chapter we will need the following R packages: - `tidyverse` - `stringr` - `dplyr`

> *Note:* Only install these if you have not already, otherwise go straight to `library()`

```{r setup-packages}
#| include: false
#| message: false
#| warning: false
#| error: false

pkgs <- c("tidyverse", "stringr", "readr", "dplyr", "DT")

install_if_missing <- pkgs[!pkgs %in% installed.packages()]
if (length(install_if_missing) > 0) {
  install.packages(install_if_missing, dependencies = TRUE)
}

# Load all your packages
lapply(pkgs, library, character.only = TRUE)
```

## Load your data

```{r}
dirty <- read.table("data/mixed_dirty.txt", sep = "\t", header=T)

#Inspect first few rows
head(dirty)
```

### 1. Fixing white spaces and NAs

It is common to encounter missing spaces in our data, but it is important to ensure that this is fixed before we start analysing our data. The `str_squish()` function trims these and replaces multiple spaces with a single one, this is an important first step before matching or grouping text variables (e.g., ‚Äúnurse ‚Äù vs ‚Äúnurse‚Äù).

```{r}

cleaning <- dirty %>%
  mutate(across(where(is.character), ~str_squish(.x)))

```

### 2. Convert numeric columns correctly

Sometimes numbers are stored as text (for example, ‚Äú170 ‚Äù or ‚ÄúNA‚Äù as a string). We need to make sure we convert those variables to numeric format.

```{r}

cleaning <- cleaning %>%
  mutate(across(c(age, height_cm, weight_kg, BMI, pack_years, FEV1_mL, FVC_mL),
                ~suppressWarnings(as.numeric(.x))))

```

### 3. Standardise categorical variables

Categorical variables often contain many variations of the same label (e.g., ‚Äúfemale‚Äù, ‚ÄúFEMALE‚Äù, or ‚ÄúF‚Äù). Here, we make them consistent using `case_when()`. The same logic applies to similar variables such as smoking status and education. Standardising is a very important step that ensures data is grouped correctly.

```{r}

cleaning <- cleaning %>%
  mutate(
    sex_clean = case_when(
      str_starts(tolower(sex), "m") ~ "Male",
      str_starts(tolower(sex), "f") ~ "Female",
      TRUE ~ "Other"
    ),
    smoking_status_clean = case_when(
      is.na(smoking_status) | smoking_status %in% c("", "NA", "Unknown", "unknown") ~ NA_character_,
      str_starts(tolower(smoking_status), "never") ~ "Never",
      str_detect(tolower(smoking_status), "current|smokes socially") & 
        !str_detect(tolower(smoking_status), "quit") ~ "Current",
      str_detect(tolower(smoking_status), "former|ex|quit") ~ "Former",
      tolower(smoking_status) == "occasional" ~ "Current",
      TRUE ~ NA_character_
    ),
    education_clean = case_when(
      is.na(education) | education %in% c("", "NA", "na", "none", "None") ~ "None",
      tolower(education) %in% c("primary") ~ "Primary",
      tolower(education) %in% c("secondary","sec","high school") ~ "Secondary",
      tolower(education) %in% c("college","uni","tertiary","masters","phd","bsc") ~ "Tertiary",
      TRUE ~ "None"
    )
  )

```

### 4. Clean job names (for this ReCoDe example)

In epidemiology studies, we often collect self-reported data like occupational data for our research questions. But coding job titles can be messy, (if not using standardised tools) resulting in misspellings (‚Äúnuse‚Äù), inconsistent forms (‚Äúmining‚Äù vs ‚Äúminer‚Äù), or abbreviations. By converting everything to lowercase first and then mapping known variants to standard labels, we make sure occupations are consistent and ready to categorise later (e.g., into exposure groups).

```{r}

cleaning <- cleaning %>%
  mutate(
    job_lc = tolower(job),
    job_clean = case_when(
      job_lc %in% c("nuse","nurse") ~ "nurse",
      job_lc %in% c("miner","mining") ~ "miner",
      job_lc %in% c("constructor","construction") ~ "construction worker",
      job_lc == "office" ~ "office worker",
      job_lc == "teacher" ~ "teacher",
      job_lc == "farmer" ~ "farmer",
      job_lc == "driver" ~ "driver",
      job_lc == "welder" ~ "welder",
      job_lc == "factory" ~ "factory worker",
      job_lc == "carpenter" ~ "carpenter",
      job_lc == "doctor" ~ "doctor",
      job_lc == "security" ~ "security",
      job_lc == "cleaner" ~ "cleaner",
      job_lc == "mechanic" ~ "mechanic",
      job_lc == "electrician" ~ "electrician",
      job_lc == "bartender" ~ "bartender",
      job_lc == "porter" ~ "porter",
      TRUE ~ job_lc
    )
  )

```

### 5. Create a new variable

It is very common to derive and create new variables when using large datasets. In this example, we classify jobs into ***high exposure or low exposure*** categories based on potential for dust, fumes, or other respiratory hazards. This step prepares the dataset for later regression or mixed-model analyses exploring exposure‚Äìlung function relationships.

```{r}

cleaning <- cleaning %>%
  mutate(
    exposure_cat_clean = case_when(
      job_clean %in% c("miner","welder","factory worker","carpenter","mechanic","electrician") ~ "high_exposure",
      job_clean %in% c("office worker","teacher","doctor","nurse","construction worker", "security","cleaner","bartender","porter","farmer","driver") ~ "low_exposure",
      TRUE ~ "low_exposure"
    )
  )

```

### 6. Convert FEV1 and FVC to litres and calculate ratio

FEV1 and FVC are recorded in millilitres in the raw data, so we convert them to litres for analysis. The FEV1/FVC ratio is a key lung function indicator and values below normal suggest obstruction. During collection of this data some errors may have occurred, so it is important we remove any outliers at this stage that could bias our analyses later on.

```{r}

cleaning <- cleaning %>%
  mutate(
    FEV1_L = FEV1_mL / 1000,
    FVC_L  = FVC_mL / 1000,
    FEV1_FVC = FEV1_L / FVC_L
  ) %>%
  mutate(
    FEV1_L = if_else(!is.na(FEV1_L) & FEV1_L <= 0, NA_real_, FEV1_L),
    FVC_L  = if_else(!is.na(FVC_L) & FVC_L <= 0, NA_real_, FVC_L),
    FEV1_FVC = if_else(!is.na(FEV1_FVC) & (FEV1_FVC <= 0 | FEV1_FVC > 1.2), NA_real_, FEV1_FVC)
  )
```

### 7. Convert FEV1 and FVC to litres and calculate ratio

This step applies the *NHANES 2014* Hansen reference equations to estimate the Lower Limit of Normal (LLN) for FEV1/FVC, expressed in percent. For each participant:

-   Males use 74.5 ‚àí 0.12 √ó age

-   Females use 80.2 ‚àí 0.214 √ó age

We then compare their observed FEV1/FVC ratio (converted to a percentage) against this LLN. The new variable `Below_LLN` is coded as following:

-   1= airway obstruction

-   0= no airway obstruction

This binary flag is useful for logistic regression or for summarising the prevalence of obstruction across exposure or demographic groups. We will also use it when running different mixed-models changing the outcome variables.

```{r}

cleaning <- cleaning %>%
  mutate(
    lln_pct_male = 74.5 - 0.12 * age,
    lln_pct_fem  = 80.2 - 0.214 * age,
    lln_pct = case_when(
      sex_clean == "Male"   ~ lln_pct_male,
      sex_clean == "Female" ~ lln_pct_fem,
      TRUE ~ ((74.5 - 0.12 * age) + (80.2 - 0.214 * age)) / 2  # fallback if sex not M/F
    ),
    # Convert ratio to percent for comparison, then flag below LLN
    Below_LLN = as.integer(!is.na(FEV1_FVC) & (FEV1_FVC * 100) < lln_pct)
  ) %>%
  select(-lln_pct_male, -lln_pct_fem)

```

### ‚ú® Clean Data: Ready for Analysis

Once cleaned, the dataset becomes **`mixed_clean.txt`**, with harmonised categories, derived lung function metrics, and an approximate lower limit of normal (LLN) for FEV1/FVC. This version can be used for teaching model fitting, random effects, and basic interpretation of respiratory epidemiology results.

```{r}
library(knitr)
clean <- read.table("data/mixed_clean.txt", header = TRUE, sep = "\t")

kable(head(clean, 10))
```

### Final variables in the Clean Dataset

| Variable | Description |
|----|----|
| **id** | Unique participant identifier. |
| **site** | Study site (country); use as random intercept. |
| **age** | Age in years (numeric, cleaned). |
| **sex** | Standardised sex: *Male*, *Female*, or *Other*. |
| **height_cm** | Height in centimetres (numeric, cleaned). |
| **weight_kg** | Weight in kilograms (numeric, cleaned). |
| **BMI** | Body mass index derived from height and weight. |
| **smoking_status** | Recoded smoking category: *Never*, *Former*, *Current*, *Occasional* (or NA). |
| **pack_years** | Numeric smoking exposure (may be 0 for never smokers, NA if unknown). |
| **education** | Cleaned education level: *None*, *Primary*, *Secondary*, *Tertiary*. |
| **job** | Original reported occupation (as entered). |
| **job_clean** | Standardised occupation label (e.g., *miner*, *office worker*). |
| **exposure_cat** | Original exposure category from the raw file (left for reference). |
| **exposure_cat_clean** | Clean binary exposure category: *low_exposure* or *high_exposure* based on `job_clean`. |
| **FEV1_mL** | FEV1 in millilitres (numeric, cleaned). |
| **FVC_mL** | FVC in millilitres (numeric, cleaned). |
| **FEV1_L** | FEV1 converted to litres. |
| **FVC_L** | FVC converted to litres. |
| **FEV1_FVC** | Ratio FEV1/FVC (unitless). |
| **LLN_FEV1FVC_approx** | Age/sex‚Äìadjusted approximate LLN for FEV1/FVC (NHANES-inspired, for teaching). |
| **Below_LLN** | Indicator of obstruction: 1 = FEV1/FVC below LLN, 0 = otherwise. |

{
  "hash": "e419a823c081058d43305f7e7ced7548",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Visualisation\"\nformat: html\neditor: visual\n---\n\nPresenting our results in a way that others can understand is important to help us interpret the results.\n\nFor this chapter we will need the following R packages: `dplyr` `tidyr` `lme4` `ggplot2` `tidyverse` `broom.mixed`\n\n> *Note:* Only install these if you have not already, otherwise go straight to `library()`\n\n\n\n## Random intercept model\n\nLet's first assume, we are interested in the overall slope of the relationship between exposure level and lung function (FEV1/FVC).We can check the predicted coefficients.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(lme4)\nclean <- read.table(\"data/mixed_clean.txt\", header=T, sep=\"\\t\")\nmod_mixed <- lmer(\nFEV1_FVC ~ exposure_cat_clean + smoking_status_clean + age + sex_clean + BMI +\n(1 | site), data = clean)\n\n#Derive coefficients\nmodel_coefs <- coef(mod_mixed)$site %>%\n  as.data.frame() %>%\n  rownames_to_column(\"site\") %>%\n  rename(\n    Intercept = `(Intercept)`,\n    Slope = `exposure_cat_cleanlow_exposure`\n  ) %>%\n  select(site, Intercept, Slope)\n\nmodel_coefs\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          site Intercept     Slope\n1    Australia 0.5762985 0.1413133\n2     Colombia 0.6661329 0.1413133\n3        India 0.6214658 0.1413133\n4       Poland 0.7056503 0.1413133\n5 South Africa 0.7732532 0.1413133\n6           UK 0.6414481 0.1413133\n7          USA 0.6607203 0.1413133\n8      Vietnam 0.7394149 0.1413133\n```\n\n\n:::\n\n```{.r .cell-code}\n#Join coefficients to the clean dataset \nclean <- left_join(clean, model_coefs, by = \"site\")\n```\n:::\n\n\n### Graphical representation\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Mutate names\nclean <- clean |>\n  dplyr::mutate(\n    exposure_cat_clean = factor(\n      exposure_cat_clean,\n      levels = c(\"low_exposure\", \"high_exposure\")\n    ),\n    exposure_num = ifelse(exposure_cat_clean == \"low_exposure\", 0, 1)\n  )\n\ncoef_df <- model_coefs |>\n  tidyr::expand_grid(exposure_num = c(0, 1)) |>\n  dplyr::mutate(\n    FEV1_FVC_pred = Intercept + Slope * exposure_num\n  )\n\n\n#Plot the results\nlibrary(ggplot2)\n\nmodel_coef_plot <- ggplot(clean, aes(x = exposure_num, y = FEV1_FVC)) +\n  # raw points\n  geom_point(\n    aes(colour = site),\n    alpha    = 0.35,\n    size     = 1,\n    position = position_jitter(width = 0.03, height = 0)\n  ) +\n  # mixed-model lines\n  geom_line(\n    data = coef_df,\n    aes(x = exposure_num, y = FEV1_FVC_pred, colour = site, group = site),\n    size = 1.1\n  ) +\n  scale_x_continuous(\n    name   = \"Occupational exposure category\",\n    breaks = c(0, 1),\n    labels = c(\"Low exposure\", \"High exposure\"),\n    expand = expansion(mult = c(0.05, 0.05))\n  ) +\n  ylab(\"FEV1/FVC\") +\n  theme_minimal() +\n  theme(legend.position = \"top\")\n\nmodel_coef_plot\n```\n\n::: {.cell-output-display}\n![](results_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n### Caterpillar plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nran <- broom.mixed::tidy(mod_mixed, effects = \"ran_vals\") %>%\n  filter(term == \"(Intercept)\") %>%\n  mutate(\n    site = reorder(level, estimate)  # order by effect size\n  )\n\nggplot(ran, aes(x = estimate, y = site, colour = site)) +\n  geom_vline(xintercept = 0, linetype = \"dashed\", colour = \"grey50\") +\n  geom_point(size = 3) +\n  geom_errorbarh(aes(xmin = estimate - 1.96*std.error,\n                     xmax = estimate + 1.96*std.error),\n                 height = 0.2, size = 0.9) +\n  labs(\n    title = \"Site-Specific Random Intercepts\",\n        x = \"Site deviation from overall intercept\",\n    y = \"Site\"\n  ) +\n  theme_minimal(base_size = 14) +\n  theme(\n    legend.position = \"none\",\n    plot.title = element_text(face = \"bold\")\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: `geom_errobarh()` was deprecated in ggplot2 4.0.0.\nℹ Please use the `orientation` argument of `geom_errorbar()` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](results_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nIn this plot we can see that the estimated random intercepts from the mixed model, which represent how each site differs from the overall baseline level of FEV1/FVC. - Sites with positive values start higher than the mean, while those with negative values start lower. The confidence intervals show the precision of each estimate.\n\nTogether, these results show that baseline lung function varies substantially across sites, supporting the use of a random-intercept structure in the model.\n\n# **Interpretation of the mixed-model results**\n\n| Type   | Term                              | Estimate | Std. Error |  t value |\n|:-------|:----------------------------------|---------:|-----------:|---------:|\n| Random | Intercept                         |   0.0642 |         NA |       NA |\n| Random | Observation                       |   0.0501 |         NA |       NA |\n| Fixed  | (Intercept)                       |   0.8427 |     0.0247 |  34.1780 |\n| Fixed  | High exposure (vs low exposure)   |  -0.1413 |     0.0028 | -49.8576 |\n| Fixed  | Previous smoker (vs never smoker) |  -0.0239 |     0.0035 |  -6.7617 |\n| Fixed  | Current smoker (vs never smoker)  |  -0.0284 |     0.0036 |  -7.7856 |\n| Fixed  | Age                               |  -0.0014 |     0.0001 | -19.8457 |\n| Fixed  | Male (vs female)                  |   0.0009 |     0.0027 |   0.3312 |\n| Fixed  | BMI                               |   0.0001 |     0.0003 |   0.3976 |\n\n### **Fixed effects**\n\n-   **High vs low exposure** Individuals in the *low exposure* group have, on average, **0.141 higher FEV1/FVC** than those in the *high exposure* group (when accounting for smoking, age, sex, BMI).\n\nThis is a **highly precise effect** (t ≈ 50).\n\n-   **Smoking status**\n\n    -   Previous smokers have a 0.0239 lower FEV1/FVC compared to never smokers\n\n    -   Current smokers have a 0.0284 lower FEV1/FVC ration compared to never smokers\n\n-   **Age:**\n\n    -   FEV1/FVC decreases by 0.00136 per year of age, showing a clear age-related decline\n\n-   **Sex and BMI:**\n\n    -   Both effects are small and not statistically significant in this model.\n\n### **Random effects (site-level variation)**\n\n-   Sites differ in their baseline FEV1/FVC by an SD of 0.064, which is larger than the residual SD (0.050)\n\n    -   This means between-site differences are real.\n\n-   The caterpillar plot shows that some sites start well above the overall mean and some below, validating the need for a random intercept by site\n\n### **Model fit & implications**\n\n-   The difference between site-level variance and residual variance indicates that a mixed model is appropriate, since ignoring site would incorrectly pool together populations with different baseline lung function.\n\n-   The exposure effect (low vs high) is consistent across sites because your model uses random intercepts only and the plot confirms that the baseline varies, but the exposure slope does not\n",
    "supporting": [
      "results_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
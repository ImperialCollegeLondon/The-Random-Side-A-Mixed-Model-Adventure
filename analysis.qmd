---
title: "Analysis"
format: html
editor: visual
---

## Mixed Models Analysis

For this chapter we will need the following R packages: ``` dplyr``gt ``` `lme4` `broom` `broom.mixed`

> *Note:* Only install these if you have not already, otherwise go straight to `library()`

```{r setup-packages}
#| include: false
#| message: false
#| warning: false
#| error: false

pkgs <- c("dplyr", "lme4", "broom", "broom.mixed", "gt")

install_if_missing <- pkgs[!pkgs %in% installed.packages()]
if (length(install_if_missing) > 0) {
  install.packages(install_if_missing, dependencies = TRUE)
}

# Load all your packages
lapply(pkgs, library, character.only = TRUE)
```

### What exactly do we mean by ‚Äúmixed effects‚Äù in this context?

Before we move on to modelling, it‚Äôs worth pausing to clarify what we mean by *mixed* effects and why they matter for this type of epidemiological dataset.

A **mixed effects model** includes two types of predictors:

1.  **Fixed effects** ‚Äì\
    These are the standard variables you see in a typical regression model: age, sex, BMI, smoking status, exposure category, etc.\
    They are called *fixed* because the effect we estimate is assumed to be the same across all individuals and all sites.\
    These are usually the variables we actually care about drawing conclusions from.

2.  **Random effects** ‚Äì\
    These account for **structured dependence** in the data where observations are *not* fully independent. They typically correspond to a grouping factor such as:

```         
-   Repeated measures per person

-   Students within school

-   Patients within hospitals, or in our case

-   **Participants nested inside study sites (countries)**
```

Random effects let us acknowledge that people measured in the same site share something that cannot be explained by our covariates.

## Why does site matter as a random effect?

In this example, each participant belongs to one of several study sites (e.g., UK, Colombia, South Africa). Even though everyone is measured with the same lung function test, each site can differ in ways that influence lung function, (e.g., differences in equipment calibration, technician training, recruitment patterns, environmental pollution, healthcare access...)

None of these are measured in our dataset, yet all of them can systematically impact the mean FEV1/FVC ratio at a site. This means that **participants from the same site are more similar to each other** than to participants from a different site (no independent observations).

If we ignore this clustering and use ordinary regression, those unmeasured site-level factors can impact our estimates of the fixed effects such as smoking or exposure category.

A **random intercept for site** absorbs those differences by allowing each site to have its own baseline level of lung function.

### Classic regression vs Mixed models: Let's break it down!

+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Participant          | Description                                                                                                                                                                                       |
+======================+===================================================================================================================================================================================================+
| Person A             | 45-year-old, non-smoking, male, normal BMI, working in a low-exposure job in **Vietnam**                                                                                                          |
+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Person B             | 45-year-old, non-smoking, male, normal BMI, working in a low-exposure job in the **UK**                                                                                                           |
+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Key idea             | By their fixed-effect variables (age, sex, BMI, smoking, exposure), these two people look identical, but their lung function may still differ because their **sites** differ, not because they do |
+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Fixed-only model     | Treats Person A and Person B as interchangeable, ignoring site                                                                                                                                    |
|                      |                                                                                                                                                                                                   |
| (classic regression) |                                                                                                                                                                                                   |
+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Mixed model          | There may be a site-level shift in outcomes that I cannot directly observe. Let me adjust for it so I can interpret the fixed effects cleanly                                                     |
+----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

# Fixed Effects vs Mixed Effects in action

## 1. Fixed Effects

Before exploring mixed-effects models, it is important to build a solid foundation of what **fixed effects** are. These models assume all individuals are independent from each other, and that any differences in lung function can be explained exclusively by the included predictors.

In this first part, we will use a **standard linear regression** to estimate associations between predictors (age, sex, smoking, exposure category, BMI) and the **continuous outcome** FEV1/FVC.

Fixed effects are the variables we explicitly include in the model because we believe they **directly influence the outcome**. In this dataset, these include:

-   exposure category (high vs low)

-   smoking status

-   age

-   sex

-   BMI

These effects are called *fixed* because each coefficient represents one **single average effect** applied to everyone in the dataset.

```{r}
clean <- read.table("data/mixed_clean.txt", header=T, sep="\t")

#Specific the reference levels for your variables 
clean$smoking_status_clean <- factor(
  clean$smoking_status_clean,
  levels = c("Never", "Former", "Current", "Occasional")
)

clean$exposure_cat_clean <- factor(
  clean$exposure_cat_clean,
  levels = c("low_exposure", "high_exposure")
)

#Run the model 
mod_fixed <- lm(
FEV1_FVC ~ exposure_cat_clean + smoking_status_clean + age + sex_clean + BMI,
data = clean)

#summary(mod_fixed) Use this to visualise the model output

tidy(mod_fixed) %>%
    # Rename model terms for clarity
    mutate(term = recode(term,
                         "(Intercept)" = "Intercept",
                         "exposure_cat_cleanhigh_exposure" = "High exposure (vs low)",
                         "smoking_status_cleanFormer" = "Former smoker (vs never)",
                         "smoking_status_cleanCurrent" = "Current smoker (vs never)",
                         "age" = "Age (years)",
                         "sex_cleanMale" = "Male (vs female)",
                         "BMI" = "Body Mass Index"
    )) %>%
    # Round numbers and replace tiny p-values with "<0.001"
    mutate(
        across(c(estimate, std.error, statistic), round, 4),
        p.value = ifelse(p.value < 0.001, "<0.001",
                         formatC(p.value, format = "f", digits = 3))
    ) %>%
    gt() %>%
    tab_header(title = "Fixed-Effects Regression Results") %>%
    cols_label(
        term = "Variable",
        estimate = "Estimate",
        std.error = "Std. Error",
        statistic = "t value",
        p.value = "p-value"
    )

```

> Note: The coefficients represente the average change in FEV1/FVC associated with each variable in our model.
>
> -   This assumes that everyone is independent, even if two individuals are from the same site (country) or share unmeasured similarities
>
> -   Std.errors may be too small id there is clustering (e.g., by site/country)
>
> -   Results may be biased

## 2. Mixed-Effects Model

The `lme4` package is one of the most widely used in R to run this analysis.
In this example we will fit a mixed effect model with random intercept by site

```{r}

mod_mixed <- lmer(
FEV1_FVC ~ exposure_cat_clean + smoking_status_clean + age + sex_clean + BMI +
(1 | site), data = clean)

#summary(mod_mixed)


tidy(mod_mixed, effects = "fixed") %>%
  mutate(
    term = recode(term,
      "(Intercept)" = "Intercept",
      "exposure_cat_cleanhigh_exposure" = "High exposure (vs low)",
      "smoking_status_cleanFormer"     = "Former smoker (vs never)",
      "smoking_status_cleanCurrent"    = "Current smoker (vs never)",
      "age"                            = "Age (years)",
      "sex_cleanMale"                  = "Male (vs female)",
      "BMI"                            = "Body Mass Index"
    ),
    # Wald 95% CI
    ci_low  = estimate - 1.96 * std.error,
    ci_high = estimate + 1.96 * std.error
  ) %>%
  transmute(
    Variable = term,
    Estimate = round(estimate, 2),
    `95% CI (low)`  = round(ci_low, 2),
    `95% CI (high)` = round(ci_high, 2),
    `Std. Error`    = round(std.error, 2)
  ) %>%
  gt() %>%
  tab_header(title = "Mixed-Effects Model for FEV1/FVC (Random Intercept: Site)")

```

### üß© What does (1 | site) mean? 

The term (1 \| site) in our code adds a random intercept for each study site. It allows every site to have its own baseline FEV‚ÇÅ/FVC, while assuming those intercepts are normally distributed around the overall mean.

-   This captures unmeasured, site-specific influences for example, differences in equipment, technician calibration, population characteristics, or local environments

-   Including (1 \| site) controls for clustering among participants from the same site without fitting a separate fixed effect for every country. It ensures that the estimated effects of variables like age, smoking, and occupational exposure are not biased by unaccounted site-level variability.

### How can we be sure that a mixed model should be used?

```{r}

var_comp <- as.data.frame(VarCorr(mod_mixed))
icc <- var_comp$vcov[var_comp$grp == "site"] / sum(var_comp$vcov)
icc
```

> Note: A high interclass correlation (ICC) indicates more similarities within sites and a stronger justification for using mixed models

#### More resources 

[lme4 CRAN package vignettes](<https://cran.r-project.org/web/packages/lme4/vignettes/lmer.pdf>)


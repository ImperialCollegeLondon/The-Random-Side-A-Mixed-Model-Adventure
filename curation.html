<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Data Curation ‚Äì ReCoDE: Mixed models R tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-72d15cbaaff2a8b1f75ed27836891bb3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-2fe420d1df21a49b32ae83e720402e79.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-72d15cbaaff2a8b1f75ed27836891bb3.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./img/iclogo.png" alt="" class="navbar-logo light-content">
    <img src="./img/iclogo.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ReCoDE: Mixed models R tutorial</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./intro_mixed.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./curation.html" aria-current="page"> 
<span class="menu-text">Curation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./analysis_1.html"> 
<span class="menu-text">Analysis</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ImperialCollegeLondon/ReCoDE-exemplar-template-R"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about-the-dataset" id="toc-about-the-dataset" class="nav-link active" data-scroll-target="#about-the-dataset">About the dataset</a>
  <ul class="collapse">
  <li><a href="#lets-get-cleaning" id="toc-lets-get-cleaning" class="nav-link" data-scroll-target="#lets-get-cleaning">üßπ Let‚Äôs Get Cleaning!</a></li>
  </ul></li>
  <li><a href="#install-relevant-packages-and-load-your-data" id="toc-install-relevant-packages-and-load-your-data" class="nav-link" data-scroll-target="#install-relevant-packages-and-load-your-data">Install relevant packages and load your data</a></li>
  <li><a href="#load-your-data" id="toc-load-your-data" class="nav-link" data-scroll-target="#load-your-data">Load your data</a>
  <ul class="collapse">
  <li><a href="#fixing-white-spaces-and-nas" id="toc-fixing-white-spaces-and-nas" class="nav-link" data-scroll-target="#fixing-white-spaces-and-nas">1. Fixing white spaces and NAs</a></li>
  <li><a href="#convert-numeric-columns-correctly" id="toc-convert-numeric-columns-correctly" class="nav-link" data-scroll-target="#convert-numeric-columns-correctly">2. Convert numeric columns correctly</a></li>
  <li><a href="#standardise-categorical-variables" id="toc-standardise-categorical-variables" class="nav-link" data-scroll-target="#standardise-categorical-variables">3. Standardise categorical variables</a></li>
  <li><a href="#clean-job-names-for-this-recode-example" id="toc-clean-job-names-for-this-recode-example" class="nav-link" data-scroll-target="#clean-job-names-for-this-recode-example">4. Clean job names (for this ReCoDe example)</a></li>
  <li><a href="#create-a-new-variable" id="toc-create-a-new-variable" class="nav-link" data-scroll-target="#create-a-new-variable">5. Create a new variable</a></li>
  <li><a href="#convert-fev1-and-fvc-to-litres-and-calculate-ratio" id="toc-convert-fev1-and-fvc-to-litres-and-calculate-ratio" class="nav-link" data-scroll-target="#convert-fev1-and-fvc-to-litres-and-calculate-ratio">6. Convert FEV1 and FVC to litres and calculate ratio</a></li>
  <li><a href="#convert-fev1-and-fvc-to-litres-and-calculate-ratio-1" id="toc-convert-fev1-and-fvc-to-litres-and-calculate-ratio-1" class="nav-link" data-scroll-target="#convert-fev1-and-fvc-to-litres-and-calculate-ratio-1">7. Convert FEV1 and FVC to litres and calculate ratio</a></li>
  <li><a href="#clean-data-ready-for-analysis" id="toc-clean-data-ready-for-analysis" class="nav-link" data-scroll-target="#clean-data-ready-for-analysis">‚ú® Clean Data: Ready for Analysis</a></li>
  <li><a href="#final-variables-in-the-clean-dataset" id="toc-final-variables-in-the-clean-dataset" class="nav-link" data-scroll-target="#final-variables-in-the-clean-dataset">Final variables in the Clean Dataset</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Curation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>It is very important to have your data ready and in the right format before you run any models. This section of the tutorial will allow you practice cleaning the data set.</p>
<section id="about-the-dataset" class="level2">
<h2 class="anchored" data-anchor-id="about-the-dataset">About the dataset</h2>
<p>The dataset contains simulated data for 2,000 adults from eight study sites (UK, USA, Colombia, India, South Africa, Poland, Vietnam, and Australia). It was generated to illustrate mixed-effects modeling and data cleaning workflows in respiratory epidemiology. Each participant has demographic, occupational, and lung function information designed to reflect a realistic example.</p>
<section id="lets-get-cleaning" class="level3">
<h3 class="anchored" data-anchor-id="lets-get-cleaning">üßπ Let‚Äôs Get Cleaning!</h3>
<p>Before jumping into mixed-modelling, we need to tackle some messy data. The <strong>dirty dataset (<code>mixed_dirty.txt</code>)</strong> mirrors the kind of inconsistencies found in real epidemiological studies, including: typos, missing entries, odd units, and empty spaces.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>id</strong></td>
<td>Unique participant identifier (1‚Äì2000)</td>
</tr>
<tr class="even">
<td><strong>site</strong></td>
<td>Study site (country: UK, USA, Colombia, India, South Africa, Poland, Vietnam, or Australia)</td>
</tr>
<tr class="odd">
<td><strong>age</strong></td>
<td>Participant age in years (contains missing values)</td>
</tr>
<tr class="even">
<td><strong>sex</strong></td>
<td>Recorded sex (e.g., ‚ÄúM‚Äù, ‚ÄúF‚Äù, ‚Äúmale‚Äù, ‚ÄúFemale‚Äù, ‚Äúf‚Äù, ‚Äúm‚Äù, ‚Äúother‚Äù)</td>
</tr>
<tr class="odd">
<td><strong>height_cm</strong></td>
<td>Height in centimetres (may include blanks, ‚ÄúNA‚Äù, or blank spaces)</td>
</tr>
<tr class="even">
<td><strong>weight_kg</strong></td>
<td>Weight in kilograms (some missing or inconsistent entries)</td>
</tr>
<tr class="odd">
<td><strong>BMI</strong></td>
<td>Body mass index derived from height and weight; includes rounding errors and missing values</td>
</tr>
<tr class="even">
<td><strong>smoking_status</strong></td>
<td>Self-reported smoking behaviour with inconsistent text (e.g., ‚ÄúNever‚Äù, ‚Äúnever‚Äù, ‚ÄúCURRENT‚Äù, ‚Äúex‚Äù, ‚Äúquit&gt;1y‚Äù, ‚ÄúUnknown‚Äù)</td>
</tr>
<tr class="odd">
<td><strong>pack_years</strong></td>
<td>Approximate pack-years of smoking exposure (some missing or inconsistent with smoking status)</td>
</tr>
<tr class="even">
<td><strong>education</strong></td>
<td>Educational attainment (free-text responses such as ‚Äúprimary‚Äù, ‚Äúsec‚Äù, ‚ÄúCollege‚Äù, ‚Äúuni‚Äù, or blanks)</td>
</tr>
<tr class="odd">
<td><strong>job</strong></td>
<td>Reported occupation, intentionally messy (e.g., ‚Äúnuse‚Äù, ‚Äúmining‚Äù, ‚Äúconstructor‚Äù, ‚Äúteacher‚Äù, ‚Äúoffice‚Äù)</td>
</tr>
<tr class="even">
<td><strong>exposure_cat</strong></td>
<td>Occupational exposure category (‚Äúlow‚Äù or ‚Äúhigh_exposure‚Äù) with inconsistent naming</td>
</tr>
<tr class="odd">
<td><strong>FEV1_mL</strong></td>
<td>Forced Expiratory Volume in 1 second, in millilitres; includes outliers, missing values, and some negative entries</td>
</tr>
<tr class="even">
<td><strong>FVC_mL</strong></td>
<td>Forced Vital Capacity, in millilitres; includes missing values</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><em>Note:</em> The <code>mixed_dirty.txt</code> dataset includes deliberate inconsistencies and data quality issues for you to identify and correct during cleaning exercises (e.g., converting FEV1/FVC to litres, standardise categorical variables, and deriving exposure categories).</p>
</blockquote>
<p>Your task is to explore, clean, and prepare it for analysis.</p>
</section>
</section>
<section id="install-relevant-packages-and-load-your-data" class="level2">
<h2 class="anchored" data-anchor-id="install-relevant-packages-and-load-your-data">Install relevant packages and load your data</h2>
<p>For this chapter we will need the following R packages: - <code>tidyverse</code> - <code>stringr</code> - <code>dplyr</code></p>
<blockquote class="blockquote">
<p><em>Note:</em> Only install these if you have not already, otherwise go straight to <code>library()</code></p>
</blockquote>
</section>
<section id="load-your-data" class="level2">
<h2 class="anchored" data-anchor-id="load-your-data">Load your data</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dirty <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"data/mixed_dirty.txt"</span>, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">header=</span>T)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Inspect first few rows</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dirty)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id    site age    sex height_cm weight_kg  BMI   smoking_status pack_years
1  1      UK  77   male     181.5      97.9 29.7       Occasional       11.0
2  2 Vietnam  22      m     157.2      62.6 25.3          CURRENT       15.2
3  3  Poland  45      M     146.3      48.3 22.6                         0.0
4  4   India  49 Female     149.1      62.2 28.0          current        6.7
5  5   India  72      m     177.8      67.7 21.4          quit&lt;1y        0.0
6  6 Vietnam  26  other     160.4      78.8 30.6 Smokes socially         6.9
  education       job  exposure_cat FEV1_mL FVC_mL
1  tertiary bartender           LOW    3469   4918
2       BSc    porter           LOW    4360   5107
3   primary   factory high_exposure    3154   4898
4 Secondary   factory high_exposure    1876   3283
5           security            hi     3002   5338
6   College    doctor           low    3010   3888</code></pre>
</div>
</div>
<section id="fixing-white-spaces-and-nas" class="level3">
<h3 class="anchored" data-anchor-id="fixing-white-spaces-and-nas">1. Fixing white spaces and NAs</h3>
<p>It is common to encounter missing spaces in our data, but it is important to ensure that this is fixed before we start analysing our data. The <code>str_squish()</code> function trims these and replaces multiple spaces with a single one, this is an important first step before matching or grouping text variables (e.g., ‚Äúnurse‚Äù vs ‚Äúnurse‚Äù).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cleaning <span class="ot">&lt;-</span> dirty <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character), <span class="sc">~</span><span class="fu">str_squish</span>(.x)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="convert-numeric-columns-correctly" class="level3">
<h3 class="anchored" data-anchor-id="convert-numeric-columns-correctly">2. Convert numeric columns correctly</h3>
<p>Sometimes numbers are stored as text (for example, ‚Äú170‚Äù or ‚ÄúNA‚Äù as a string). We need to make sure we convert those variables to numeric format.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cleaning <span class="ot">&lt;-</span> cleaning <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(age, height_cm, weight_kg, BMI, pack_years, FEV1_mL, FVC_mL),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span><span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.x))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="standardise-categorical-variables" class="level3">
<h3 class="anchored" data-anchor-id="standardise-categorical-variables">3. Standardise categorical variables</h3>
<p>Categorical variables often contain many variations of the same label (e.g., ‚Äúfemale‚Äù, ‚ÄúFEMALE‚Äù, or ‚ÄúF‚Äù). Here, we make them consistent using <code>case_when()</code>. The same logic applies to similar variables such as smoking status and education. Standardising is a very important step that ensures data is grouped correctly.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cleaning <span class="ot">&lt;-</span> cleaning <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">sex_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_starts</span>(<span class="fu">tolower</span>(sex), <span class="st">"m"</span>) <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_starts</span>(<span class="fu">tolower</span>(sex), <span class="st">"f"</span>) <span class="sc">~</span> <span class="st">"Female"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">smoking_status_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(smoking_status) <span class="sc">|</span> smoking_status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"Unknown"</span>, <span class="st">"unknown"</span>) <span class="sc">~</span> <span class="cn">NA_character_</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_starts</span>(<span class="fu">tolower</span>(smoking_status), <span class="st">"never"</span>) <span class="sc">~</span> <span class="st">"Never"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(<span class="fu">tolower</span>(smoking_status), <span class="st">"current|smokes socially"</span>) <span class="sc">&amp;</span> </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">str_detect</span>(<span class="fu">tolower</span>(smoking_status), <span class="st">"quit"</span>) <span class="sc">~</span> <span class="st">"Current"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(<span class="fu">tolower</span>(smoking_status), <span class="st">"former|ex|quit"</span>) <span class="sc">~</span> <span class="st">"Former"</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tolower</span>(smoking_status) <span class="sc">==</span> <span class="st">"occasional"</span> <span class="sc">~</span> <span class="st">"Current"</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">education_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(education) <span class="sc">|</span> education <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"NA"</span>, <span class="st">"na"</span>, <span class="st">"none"</span>, <span class="st">"None"</span>) <span class="sc">~</span> <span class="st">"None"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tolower</span>(education) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"primary"</span>) <span class="sc">~</span> <span class="st">"Primary"</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tolower</span>(education) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"secondary"</span>,<span class="st">"sec"</span>,<span class="st">"high school"</span>) <span class="sc">~</span> <span class="st">"Secondary"</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tolower</span>(education) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"college"</span>,<span class="st">"uni"</span>,<span class="st">"tertiary"</span>,<span class="st">"masters"</span>,<span class="st">"phd"</span>,<span class="st">"bsc"</span>) <span class="sc">~</span> <span class="st">"Tertiary"</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"None"</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="clean-job-names-for-this-recode-example" class="level3">
<h3 class="anchored" data-anchor-id="clean-job-names-for-this-recode-example">4. Clean job names (for this ReCoDe example)</h3>
<p>In epidemiology studies, we often collect self-reported data like occupational data for our research questions. But coding job titles can be messy, (if not using standardised tools) resulting in misspellings (‚Äúnuse‚Äù), inconsistent forms (‚Äúmining‚Äù vs ‚Äúminer‚Äù), or abbreviations. By converting everything to lowercase first and then mapping known variants to standard labels, we make sure occupations are consistent and ready to categorise later (e.g., into exposure groups).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cleaning <span class="ot">&lt;-</span> cleaning <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">job_lc =</span> <span class="fu">tolower</span>(job),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">job_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"nuse"</span>,<span class="st">"nurse"</span>) <span class="sc">~</span> <span class="st">"nurse"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"miner"</span>,<span class="st">"mining"</span>) <span class="sc">~</span> <span class="st">"miner"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"constructor"</span>,<span class="st">"construction"</span>) <span class="sc">~</span> <span class="st">"construction worker"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"office"</span> <span class="sc">~</span> <span class="st">"office worker"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"teacher"</span> <span class="sc">~</span> <span class="st">"teacher"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"farmer"</span> <span class="sc">~</span> <span class="st">"farmer"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"driver"</span> <span class="sc">~</span> <span class="st">"driver"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"welder"</span> <span class="sc">~</span> <span class="st">"welder"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"factory"</span> <span class="sc">~</span> <span class="st">"factory worker"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"carpenter"</span> <span class="sc">~</span> <span class="st">"carpenter"</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"doctor"</span> <span class="sc">~</span> <span class="st">"doctor"</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"security"</span> <span class="sc">~</span> <span class="st">"security"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"cleaner"</span> <span class="sc">~</span> <span class="st">"cleaner"</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"mechanic"</span> <span class="sc">~</span> <span class="st">"mechanic"</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"electrician"</span> <span class="sc">~</span> <span class="st">"electrician"</span>,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"bartender"</span> <span class="sc">~</span> <span class="st">"bartender"</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      job_lc <span class="sc">==</span> <span class="st">"porter"</span> <span class="sc">~</span> <span class="st">"porter"</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> job_lc</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="create-a-new-variable" class="level3">
<h3 class="anchored" data-anchor-id="create-a-new-variable">5. Create a new variable</h3>
<p>It is very common to derive and create new variables when using large datasets. In this example, we classify jobs into <strong><em>high exposure or low exposure</em></strong> categories based on potential for dust, fumes, or other respiratory hazards. This step prepares the dataset for later regression or mixed-model analyses exploring exposure‚Äìlung function relationships.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cleaning <span class="ot">&lt;-</span> cleaning <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">exposure_cat_clean =</span> <span class="fu">case_when</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>      job_clean <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"miner"</span>,<span class="st">"welder"</span>,<span class="st">"factory worker"</span>,<span class="st">"carpenter"</span>,<span class="st">"mechanic"</span>,<span class="st">"electrician"</span>) <span class="sc">~</span> <span class="st">"high_exposure"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      job_clean <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"office worker"</span>,<span class="st">"teacher"</span>,<span class="st">"doctor"</span>,<span class="st">"nurse"</span>,<span class="st">"construction worker"</span>, <span class="st">"security"</span>,<span class="st">"cleaner"</span>,<span class="st">"bartender"</span>,<span class="st">"porter"</span>,<span class="st">"farmer"</span>,<span class="st">"driver"</span>) <span class="sc">~</span> <span class="st">"low_exposure"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"low_exposure"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="convert-fev1-and-fvc-to-litres-and-calculate-ratio" class="level3">
<h3 class="anchored" data-anchor-id="convert-fev1-and-fvc-to-litres-and-calculate-ratio">6. Convert FEV1 and FVC to litres and calculate ratio</h3>
<p>FEV1 and FVC are recorded in millilitres in the raw data, so we convert them to litres for analysis. The FEV1/FVC ratio is a key lung function indicator and values below normal suggest obstruction. During collection of this data some errors may have occurred, so it is important we remove any outliers at this stage that could bias our analyses later on.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cleaning <span class="ot">&lt;-</span> cleaning <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">FEV1_L =</span> FEV1_mL <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">FVC_L  =</span> FVC_mL <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">FEV1_FVC =</span> FEV1_L <span class="sc">/</span> FVC_L</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">FEV1_L =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(FEV1_L) <span class="sc">&amp;</span> FEV1_L <span class="sc">&lt;=</span> <span class="dv">0</span>, <span class="cn">NA_real_</span>, FEV1_L),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">FVC_L  =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(FVC_L) <span class="sc">&amp;</span> FVC_L <span class="sc">&lt;=</span> <span class="dv">0</span>, <span class="cn">NA_real_</span>, FVC_L),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">FEV1_FVC =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(FEV1_FVC) <span class="sc">&amp;</span> (FEV1_FVC <span class="sc">&lt;=</span> <span class="dv">0</span> <span class="sc">|</span> FEV1_FVC <span class="sc">&gt;</span> <span class="fl">1.2</span>), <span class="cn">NA_real_</span>, FEV1_FVC)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="convert-fev1-and-fvc-to-litres-and-calculate-ratio-1" class="level3">
<h3 class="anchored" data-anchor-id="convert-fev1-and-fvc-to-litres-and-calculate-ratio-1">7. Convert FEV1 and FVC to litres and calculate ratio</h3>
<p>This step applies the <em>NHANES 2014</em> Hansen reference equations to estimate the Lower Limit of Normal (LLN) for FEV1/FVC, expressed in percent. For each participant:</p>
<ul>
<li><p>Males use 74.5 ‚àí 0.12 √ó age</p></li>
<li><p>Females use 80.2 ‚àí 0.214 √ó age</p></li>
</ul>
<p>We then compare their observed FEV1/FVC ratio (converted to a percentage) against this LLN. The new variable <code>Below_LLN</code> is coded as following:</p>
<ul>
<li><p>1= airway obstruction</p></li>
<li><p>0= no airway obstruction</p></li>
</ul>
<p>This binary flag is useful for logistic regression or for summarising the prevalence of obstruction across exposure or demographic groups. We will also use it when running different mixed-models changing the outcome variables.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>cleaning <span class="ot">&lt;-</span> cleaning <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">lln_pct_male =</span> <span class="fl">74.5</span> <span class="sc">-</span> <span class="fl">0.12</span> <span class="sc">*</span> age,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lln_pct_fem  =</span> <span class="fl">80.2</span> <span class="sc">-</span> <span class="fl">0.214</span> <span class="sc">*</span> age,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">lln_pct =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>      sex_clean <span class="sc">==</span> <span class="st">"Male"</span>   <span class="sc">~</span> lln_pct_male,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      sex_clean <span class="sc">==</span> <span class="st">"Female"</span> <span class="sc">~</span> lln_pct_fem,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> ((<span class="fl">74.5</span> <span class="sc">-</span> <span class="fl">0.12</span> <span class="sc">*</span> age) <span class="sc">+</span> (<span class="fl">80.2</span> <span class="sc">-</span> <span class="fl">0.214</span> <span class="sc">*</span> age)) <span class="sc">/</span> <span class="dv">2</span>  <span class="co"># fallback if sex not M/F</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert ratio to percent for comparison, then flag below LLN</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Below_LLN =</span> <span class="fu">as.integer</span>(<span class="sc">!</span><span class="fu">is.na</span>(FEV1_FVC) <span class="sc">&amp;</span> (FEV1_FVC <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">&lt;</span> lln_pct)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>lln_pct_male, <span class="sc">-</span>lln_pct_fem)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="clean-data-ready-for-analysis" class="level3">
<h3 class="anchored" data-anchor-id="clean-data-ready-for-analysis">‚ú® Clean Data: Ready for Analysis</h3>
<p>Once cleaned, the dataset becomes <strong><code>mixed_clean.txt</code></strong>, with harmonised categories, derived lung function metrics, and an approximate lower limit of normal (LLN) for FEV1/FVC. This version can be used for teaching model fitting, random effects, and basic interpretation of respiratory epidemiology results.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>clean <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"data/mixed_clean.txt"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(clean, <span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 1%">
<col style="width: 3%">
<col style="width: 1%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 1%">
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 3%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">id</th>
<th style="text-align: left;">site</th>
<th style="text-align: right;">age</th>
<th style="text-align: left;">sex</th>
<th style="text-align: right;">height_cm</th>
<th style="text-align: right;">weight_kg</th>
<th style="text-align: right;">BMI</th>
<th style="text-align: left;">smoking_status</th>
<th style="text-align: right;">pack_years</th>
<th style="text-align: left;">education</th>
<th style="text-align: left;">job</th>
<th style="text-align: left;">exposure_cat</th>
<th style="text-align: right;">FEV1_mL</th>
<th style="text-align: right;">FVC_mL</th>
<th style="text-align: left;">sex_clean</th>
<th style="text-align: left;">smoking_status_clean</th>
<th style="text-align: left;">education_clean</th>
<th style="text-align: left;">job_lc</th>
<th style="text-align: left;">job_clean</th>
<th style="text-align: left;">exposure_cat_clean</th>
<th style="text-align: right;">FEV1_L</th>
<th style="text-align: right;">FVC_L</th>
<th style="text-align: right;">FEV1_FVC</th>
<th style="text-align: right;">lln_pct</th>
<th style="text-align: right;">Below_LLN</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">UK</td>
<td style="text-align: right;">77</td>
<td style="text-align: left;">male</td>
<td style="text-align: right;">181.5</td>
<td style="text-align: right;">97.9</td>
<td style="text-align: right;">29.7</td>
<td style="text-align: left;">Occasional</td>
<td style="text-align: right;">11.0</td>
<td style="text-align: left;">tertiary</td>
<td style="text-align: left;">bartender</td>
<td style="text-align: left;">LOW</td>
<td style="text-align: right;">3469</td>
<td style="text-align: right;">4918</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">Current</td>
<td style="text-align: left;">Tertiary</td>
<td style="text-align: left;">bartender</td>
<td style="text-align: left;">bartender</td>
<td style="text-align: left;">low_exposure</td>
<td style="text-align: right;">3.469</td>
<td style="text-align: right;">4.918</td>
<td style="text-align: right;">0.6486312</td>
<td style="text-align: right;">65.260</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Vietnam</td>
<td style="text-align: right;">22</td>
<td style="text-align: left;">m</td>
<td style="text-align: right;">157.2</td>
<td style="text-align: right;">62.6</td>
<td style="text-align: right;">25.3</td>
<td style="text-align: left;">CURRENT</td>
<td style="text-align: right;">15.2</td>
<td style="text-align: left;">BSc</td>
<td style="text-align: left;">porter</td>
<td style="text-align: left;">LOW</td>
<td style="text-align: right;">4360</td>
<td style="text-align: right;">5107</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">Current</td>
<td style="text-align: left;">Tertiary</td>
<td style="text-align: left;">porter</td>
<td style="text-align: left;">porter</td>
<td style="text-align: left;">low_exposure</td>
<td style="text-align: right;">4.360</td>
<td style="text-align: right;">5.107</td>
<td style="text-align: right;">0.8974913</td>
<td style="text-align: right;">71.860</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: left;">Poland</td>
<td style="text-align: right;">45</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">146.3</td>
<td style="text-align: right;">48.3</td>
<td style="text-align: right;">22.6</td>
<td style="text-align: left;"></td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">primary</td>
<td style="text-align: left;">factory</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">3154</td>
<td style="text-align: right;">4898</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Primary</td>
<td style="text-align: left;">factory</td>
<td style="text-align: left;">factory worker</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">3.154</td>
<td style="text-align: right;">4.898</td>
<td style="text-align: right;">0.6525437</td>
<td style="text-align: right;">69.100</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: left;">India</td>
<td style="text-align: right;">49</td>
<td style="text-align: left;">Female</td>
<td style="text-align: right;">149.1</td>
<td style="text-align: right;">62.2</td>
<td style="text-align: right;">28.0</td>
<td style="text-align: left;">current</td>
<td style="text-align: right;">6.7</td>
<td style="text-align: left;">Secondary</td>
<td style="text-align: left;">factory</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">1876</td>
<td style="text-align: right;">3283</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">Current</td>
<td style="text-align: left;">Secondary</td>
<td style="text-align: left;">factory</td>
<td style="text-align: left;">factory worker</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">1.876</td>
<td style="text-align: right;">3.283</td>
<td style="text-align: right;">0.4948763</td>
<td style="text-align: right;">69.714</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">India</td>
<td style="text-align: right;">72</td>
<td style="text-align: left;">m</td>
<td style="text-align: right;">177.8</td>
<td style="text-align: right;">67.7</td>
<td style="text-align: right;">21.4</td>
<td style="text-align: left;">quit&lt;1y</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">security</td>
<td style="text-align: left;">hi</td>
<td style="text-align: right;">3002</td>
<td style="text-align: right;">5338</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">Former</td>
<td style="text-align: left;">None</td>
<td style="text-align: left;">security</td>
<td style="text-align: left;">security</td>
<td style="text-align: left;">low_exposure</td>
<td style="text-align: right;">3.002</td>
<td style="text-align: right;">5.338</td>
<td style="text-align: right;">0.4858307</td>
<td style="text-align: right;">65.860</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">Vietnam</td>
<td style="text-align: right;">26</td>
<td style="text-align: left;">other</td>
<td style="text-align: right;">160.4</td>
<td style="text-align: right;">78.8</td>
<td style="text-align: right;">30.6</td>
<td style="text-align: left;">Smokes socially</td>
<td style="text-align: right;">6.9</td>
<td style="text-align: left;">College</td>
<td style="text-align: left;">doctor</td>
<td style="text-align: left;">low</td>
<td style="text-align: right;">3010</td>
<td style="text-align: right;">3888</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Current</td>
<td style="text-align: left;">Tertiary</td>
<td style="text-align: left;">doctor</td>
<td style="text-align: left;">doctor</td>
<td style="text-align: left;">low_exposure</td>
<td style="text-align: right;">3.010</td>
<td style="text-align: right;">3.888</td>
<td style="text-align: right;">0.8179380</td>
<td style="text-align: right;">73.008</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">UK</td>
<td style="text-align: right;">47</td>
<td style="text-align: left;">male</td>
<td style="text-align: right;">165.2</td>
<td style="text-align: right;">63.8</td>
<td style="text-align: right;">23.4</td>
<td style="text-align: left;">NEVER</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">high school</td>
<td style="text-align: left;">nurse</td>
<td style="text-align: left;">low</td>
<td style="text-align: right;">4029</td>
<td style="text-align: right;">5274</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">Never</td>
<td style="text-align: left;">Secondary</td>
<td style="text-align: left;">nurse</td>
<td style="text-align: left;">nurse</td>
<td style="text-align: left;">low_exposure</td>
<td style="text-align: right;">4.029</td>
<td style="text-align: right;">5.274</td>
<td style="text-align: right;">0.7071995</td>
<td style="text-align: right;">68.860</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">Poland</td>
<td style="text-align: right;">28</td>
<td style="text-align: left;">FEMALE</td>
<td style="text-align: right;">185.8</td>
<td style="text-align: right;">100.2</td>
<td style="text-align: right;">29.0</td>
<td style="text-align: left;">None</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">College</td>
<td style="text-align: left;">welder</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">3644</td>
<td style="text-align: right;">5218</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">Tertiary</td>
<td style="text-align: left;">welder</td>
<td style="text-align: left;">welder</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">3.644</td>
<td style="text-align: right;">5.218</td>
<td style="text-align: right;">0.7069593</td>
<td style="text-align: right;">74.208</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: left;">USA</td>
<td style="text-align: right;">71</td>
<td style="text-align: left;">F</td>
<td style="text-align: right;">184.4</td>
<td style="text-align: right;">88.1</td>
<td style="text-align: right;">25.9</td>
<td style="text-align: left;">quit&lt;1y</td>
<td style="text-align: right;">13.1</td>
<td style="text-align: left;">Primary</td>
<td style="text-align: left;">cleaner</td>
<td style="text-align: left;">low</td>
<td style="text-align: right;">2750</td>
<td style="text-align: right;">3922</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">Former</td>
<td style="text-align: left;">Primary</td>
<td style="text-align: left;">cleaner</td>
<td style="text-align: left;">cleaner</td>
<td style="text-align: left;">low_exposure</td>
<td style="text-align: right;">2.750</td>
<td style="text-align: right;">3.922</td>
<td style="text-align: right;">0.6687213</td>
<td style="text-align: right;">65.006</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: left;">UK</td>
<td style="text-align: right;">60</td>
<td style="text-align: left;">F</td>
<td style="text-align: right;">172.2</td>
<td style="text-align: right;">79.0</td>
<td style="text-align: right;">26.6</td>
<td style="text-align: left;">NEVER</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">college</td>
<td style="text-align: left;">mechanic</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">2226</td>
<td style="text-align: right;">3583</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">Never</td>
<td style="text-align: left;">Tertiary</td>
<td style="text-align: left;">mechanic</td>
<td style="text-align: left;">mechanic</td>
<td style="text-align: left;">high_exposure</td>
<td style="text-align: right;">2.226</td>
<td style="text-align: right;">3.583</td>
<td style="text-align: right;">0.5645303</td>
<td style="text-align: right;">67.360</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="final-variables-in-the-clean-dataset" class="level3">
<h3 class="anchored" data-anchor-id="final-variables-in-the-clean-dataset">Final variables in the Clean Dataset</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>id</strong></td>
<td>Unique participant identifier.</td>
</tr>
<tr class="even">
<td><strong>site</strong></td>
<td>Study site (country); use as random intercept.</td>
</tr>
<tr class="odd">
<td><strong>age</strong></td>
<td>Age in years (numeric, cleaned).</td>
</tr>
<tr class="even">
<td><strong>sex</strong></td>
<td>Standardised sex: <em>Male</em>, <em>Female</em>, or <em>Other</em>.</td>
</tr>
<tr class="odd">
<td><strong>height_cm</strong></td>
<td>Height in centimetres (numeric, cleaned).</td>
</tr>
<tr class="even">
<td><strong>weight_kg</strong></td>
<td>Weight in kilograms (numeric, cleaned).</td>
</tr>
<tr class="odd">
<td><strong>BMI</strong></td>
<td>Body mass index derived from height and weight.</td>
</tr>
<tr class="even">
<td><strong>smoking_status</strong></td>
<td>Recoded smoking category: <em>Never</em>, <em>Former</em>, <em>Current</em>, <em>Occasional</em> (or NA).</td>
</tr>
<tr class="odd">
<td><strong>pack_years</strong></td>
<td>Numeric smoking exposure (may be 0 for never smokers, NA if unknown).</td>
</tr>
<tr class="even">
<td><strong>education</strong></td>
<td>Cleaned education level: <em>None</em>, <em>Primary</em>, <em>Secondary</em>, <em>Tertiary</em>.</td>
</tr>
<tr class="odd">
<td><strong>job</strong></td>
<td>Original reported occupation (as entered).</td>
</tr>
<tr class="even">
<td><strong>job_clean</strong></td>
<td>Standardised occupation label (e.g., <em>miner</em>, <em>office worker</em>).</td>
</tr>
<tr class="odd">
<td><strong>exposure_cat</strong></td>
<td>Original exposure category from the raw file (left for reference).</td>
</tr>
<tr class="even">
<td><strong>exposure_cat_clean</strong></td>
<td>Clean binary exposure category: <em>low_exposure</em> or <em>high_exposure</em> based on <code>job_clean</code>.</td>
</tr>
<tr class="odd">
<td><strong>FEV1_mL</strong></td>
<td>FEV1 in millilitres (numeric, cleaned).</td>
</tr>
<tr class="even">
<td><strong>FVC_mL</strong></td>
<td>FVC in millilitres (numeric, cleaned).</td>
</tr>
<tr class="odd">
<td><strong>FEV1_L</strong></td>
<td>FEV1 converted to litres.</td>
</tr>
<tr class="even">
<td><strong>FVC_L</strong></td>
<td>FVC converted to litres.</td>
</tr>
<tr class="odd">
<td><strong>FEV1_FVC</strong></td>
<td>Ratio FEV1/FVC (unitless).</td>
</tr>
<tr class="even">
<td><strong>LLN_FEV1FVC_approx</strong></td>
<td>Age/sex‚Äìadjusted approximate LLN for FEV1/FVC (NHANES-inspired, for teaching).</td>
</tr>
<tr class="odd">
<td><strong>Below_LLN</strong></td>
<td>Indicator of obstruction: 1 = FEV1/FVC below LLN, 0 = otherwise.</td>
</tr>
</tbody>
</table>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/ImperialCollegeLondon\.github\.io\/The-Random-Side-A-Mixed-Model-Adventure\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>